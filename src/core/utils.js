import _ from"lodash";import{buildSeparateSQLQueries,pluralToSingular}from"./build.js";import sql from"../db.js";async function performQuery(e){return collectData(await fetchData(e),e)}async function fetchData(e){e=buildSeparateSQLQueries(e);return console.info(e),(await Promise.all(e.map(e=>sql.unsafe(e)))).map(e=>[...e])}function assembly(s,e,c,i,n={},o=0){return e.select?.forEach(e=>{n[c]=n[c]??{},null!=i[e]&&(n[c][e]=i[e])}),Object.keys(e.join??{}).forEach(t=>{let l=(e.join??{})[t],r=pluralToSingular(t)+"_id",a=Object.keys(i).includes(r),u=l.select?.includes(pluralToSingular(c)+"_id");null==s[t]&&(s[t]=[]),s[t].filter(e=>!(a&&null!=i[r]&&i[r]!==e.id||!0===u&&i.id!==e[pluralToSingular(c)+"_id"])).forEach(e=>{var e=assembly(s,l,t,e,void 0,o+1),r=n[c],r=(r[t]=r[t]??[],r[t]);r.get=function(t){return this.reduce((e,r)=>({...e,[r[t]]:r}),{})},null!=e[t]&&"object"==typeof e[t]&&0<Object.keys(e[t]).length&&r.push(e[t])})}),0===o&&(Object.assign(n,n[c]),delete n[c]),n}function collectData(a,s){return Object.keys(s.tables).reduce((e,r,t)=>{t=a[t];let l={},u=[];t.forEach(a=>{let e=a[r+"__id"],t=Object.keys(a).reduce((e,r)=>{var[t,l]=r.split("__");return e[t]=e[t]??{},e[t][l]=a[r],e},{});if("number"==typeof l[e])Object.keys(t).forEach(r=>{null==u[l[e]][r]&&(u[l[e]][r]=[]),Array.isArray(u[l[e]][r])&&u[l[e]][r].every(e=>!_.isEqual(e,t[r]))&&u[l[e]][r].push(t[r])});else{let r={};Object.keys(t).forEach(e=>{r[e]=[t[e]]}),u.push(r),l[e]=u.length-1}});t=u.map(e=>assembly(e,s.tables[r],r,e[r][0]));return{...e,[r]:t}},{})}export{performQuery,fetchData,collectData};