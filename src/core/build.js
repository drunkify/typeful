function pluralToSingular(e){return e.endsWith("s")?e.slice(0,-1):e}function buildWhereClause(l,i){if(!l)return"";if("$and"in l&&l.$and&&Array.isArray(l.$and)){let e=l.$and.map(e=>buildWhereClause(e,i)).filter(e=>e);return 0<e.length?`(${e.join(" AND ")})`:""}if("$or"in l&&l.$or&&Array.isArray(l.$or)){let e=l.$or.map(e=>buildWhereClause(e,i)).filter(e=>e);return 0<e.length?`(${e.join(" OR ")})`:""}let e=[];for(var[r,n]of Object.entries(l)){var u;"object"==typeof n&&null!==n&&("eq"in n&&void 0!==n.eq?(u="string"==typeof n.eq?`'${n.eq}'`:n.eq,e.push(`${i}.${r} = `+u)):"like"in n&&null!=n.like&&""!==n.like&&e.push(`${i}.${r} LIKE '${n.like}'`))}return e.join(" AND ")}function joinQuery(e){let{query:l,tableName:i,parentTable:r,sql:n}=e;n[0]+=", "+(null!=l.select&&0<l.select.length?l.select.map(e=>`${i}.${e} AS ${i}__`+e).join(", "):"");var e=pluralToSingular(i),u=pluralToSingular(r),t=i.includes(u);let a="";if(a=t||null!=l.select&&l.select.includes(u+"_id")?i+`.${u}_id = ${r}.id`:`${r}.${e}_id = ${i}.id`,l.where&&(t=buildWhereClause(l.where,i))&&(a+=" AND "+t),n[2]+=` LEFT JOIN ${i} ON `+a,l.join)for(var[o,s]of Object.entries(l.join))joinQuery({query:s,tableName:o,parentTable:i,sql:n})}function buildSelectClause(e,l,i){return null==e.select||0===e.select.length?"":e.select.map(e=>i?l+`.${e} AS ${l}__`+e:l+"."+e).join(", ")}function buildOrderByClause(e,i){return null==e.orderBy?"":" ORDER BY "+Object.entries(e.orderBy).map(([e,l])=>i+`.${e} `+l.toUpperCase()).join(", ")}function buildLimitOffsetClause(e){if(void 0===e.limit)return"";let l=" LIMIT "+e.limit;return void 0!==e.offset&&(l+=" OFFSET "+e.offset),l}function buildJoinQueries(i,r,e){let n=["SELECT "+buildSelectClause(i,r,!0)," FROM "+r,""," WHERE "+(r+`.id in (SELECT id FROM ${r})`),e,""];return i.join&&Object.keys(i.join).forEach(e=>{var l=i.join?.[e];null!=l&&joinQuery({query:l,tableName:e,parentTable:r,sql:n})}),n.join("")}function buildSeparateSQLQueries({tables:e}){var l,i,r=[];for([l,i]of Object.entries(e??{})){var n=null!=i.join,u=buildSelectClause(i,l,!n);let e=n?`WITH ${l} AS (SELECT `+buildSelectClause(i,l,!1):"SELECT "+u;e+=" FROM "+l;u=buildWhereClause(i.where,l)||"1=1",u=(u&&(e+=" WHERE "+u),buildOrderByClause(i,l));e=(e+=u)+buildLimitOffsetClause(i)+(n?") ":";"),n&&(e+=buildJoinQueries(i,l,u)),r.push(e)}return r}export{pluralToSingular,buildSeparateSQLQueries};